<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Step-Up Walk Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #ecf0f1;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .card {
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      width: 95%;
      max-width: 900px;
      height: 95vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      padding: 20px;
      text-align: center;
      background: #27ae60;
      color: white;
    }

    .controls {
      padding: 10px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 16px;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      background-color: #27ae60;
      color: white;
      cursor: pointer;
    }

    button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }

    .stats {
      text-align: center;
      margin: 5px;
      font-size: 15px;
    }

    #map {
      flex-grow: 1;
    }
  </style>
</head>
<body>

<div class="card">
  <div class="header">
    <h2>üö∂‚Äç‚ôÄÔ∏è Step-Up Walk Tracker</h2>
  </div>

  <div class="controls">
    <button id="startBtn">Start Walk</button>
    <button id="stopBtn" disabled>Stop Walk</button>
    <button id="downloadBtn" disabled>Download GeoJSON</button>
  </div>

  <div class="stats">
    <span id="timer">‚è±Ô∏è Time: 00:00</span> |
    <span id="steps">üë£ Steps: 0</span>
  </div>

  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  let map = L.map('map').setView([0, 0], 16);
  let polyline = L.polyline([], { color: 'blue', weight: 5 }).addTo(map);
  let marker = null;
  let route = [];
  let geojson = null;
  let watchId = null;
  let startTime = null;
  let timerInterval = null;

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const timerDisplay = document.getElementById('timer');
  const stepsDisplay = document.getElementById('steps');

  function updateTimer() {
    const now = new Date();
    const diff = new Date(now - startTime);
    const minutes = String(diff.getUTCMinutes()).padStart(2, '0');
    const seconds = String(diff.getUTCSeconds()).padStart(2, '0');
    timerDisplay.textContent = `‚è±Ô∏è Time: ${minutes}:${seconds}`;
  }

  function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  function estimateSteps(route) {
    let totalDist = 0;
    for (let i = 1; i < route.length; i++) {
      totalDist += haversine(
        route[i-1][0], route[i-1][1],
        route[i][0], route[i][1]
      );
    }
    const steps = Math.round(totalDist / 0.78); // avg step ~0.78m
    stepsDisplay.textContent = `üë£ Steps: ${steps}`;
    return steps;
  }

  startBtn.onclick = () => {
    route = [];
    polyline.setLatLngs([]);
    if ('geolocation' in navigator) {
      startTime = new Date();
      timerInterval = setInterval(updateTimer, 1000);

      watchId = navigator.geolocation.watchPosition(
        (position) => {
          const { latitude, longitude } = position.coords;
          const latlng = [latitude, longitude];
          map.setView(latlng, 18);

          if (!marker) {
            marker = L.marker(latlng).addTo(map);
          } else {
            marker.setLatLng(latlng);
          }

          route.push(latlng);
          polyline.setLatLngs(route);
          estimateSteps(route);
        },
        (err) => alert("Location error: " + err.message),
        { enableHighAccuracy: true }
      );

      startBtn.disabled = true;
      stopBtn.disabled = false;
      downloadBtn.disabled = true;
    }
  };

  stopBtn.onclick = () => {
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    clearInterval(timerInterval);

    // Create GeoJSON
    geojson = {
      type: "Feature",
      geometry: {
        type: "LineString",
        coordinates: route.map(p => [p[1], p[0]]) // [lng, lat]
      },
      properties: {
        startTime: startTime.toISOString(),
        steps: estimateSteps(route)
      }
    };

    downloadBtn.disabled = false;
    stopBtn.disabled = true;
    startBtn.disabled = false;
  };

  downloadBtn.onclick = () => {
    if (!geojson) return;
    const blob = new Blob([JSON.stringify(geojson, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "walk_path.geojson";
    a.click();
    URL.revokeObjectURL(url);
  };
</script>
</body>
</html>
